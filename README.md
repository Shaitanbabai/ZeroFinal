# Проект веб-сайта интернет магазина на Python Django и бота-информатора на aiogram.

## 1. Описание проекта
Проект состоит из двух приложений: 

* **Веб-сайт** интренет-магазина с разделением пользовательских интерфейсов в зависимости от роли пользователя.
Имеется система авторизации. По-умолчанию задается роль покупателя customer, она может быть изменена в стандартной 
административной панели Django на роль работника магазина salesman или другую потенциальную группу.

* **Телеграм бот** для информирования пользователей в зависимости от роли пользователя.

Также включает директорию стандартных модулей настроек Django, файлы requirements.txt, structure.txt и README.md.

Медиа-контент для оформления шаблонов находится в папках static, изображения товаров в папке media.

Стили - используются как стили Django, так и стили Bootstrap, а также пользовательские стили в style.css.

## 2. Роли пользователей
* **Не авторизованный пользователь** - имеет возможность входа на сайт, просмотра товаров и авторизации.

* **Customer** - покупатель, после авторизации имеет возможность изменения данных о себе в профиле, выбора товара, 
добавление в корзину и оформления заказа. Он также имеет доступ к личному кабинету покупателя в шаблоне purchase.html, 
 где может просмотреть свои текущие и завершенные (исторические) заказы, изменить или отменить заказы 
не переданные курьеру, написать отзыв о завершенном или отмененном заказе, повторить ранее созданный заказ. 

Покупатель или уполномоченный им через параметр telegram_key в форме заказа не авторизованный в базе сайта пользователь
может подписаться на телеграм-бот @flower_lover_shop_bot для получения уведомлений о новых заказах и 
изменении статуса незавершенных.

* **Salesman** - работник магазина, имеет те же возможности для просмотра товаров, изменения своего профиля, 
что и покупатель. Работник имеет доступ к личному кабинету продавца в шаблоне salesman.html. 
Через навигационные элементы личного кабинета работник может:
  - управлять каталогом и параметрами карточек товаров.
  - просматривать текущие и завершенные заказы,
  - изменять статусы незавершенных заказов,
  - отвечать на полученные отзывы или удалять их
  - получать отчеты и аналитику о продажах.

Продавец может путем прямой авторизации по логину и паролю в боте получать уведомления о незавершенных заказах, 
а также запрашивать отчеты о продажах и их анализ в текстовом и графическом виде.

## 3. Структура проекта

myproject/
├── business_app
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── forms.py
│   ├── models.py
│   ├── tests.py
│   ├── urls.py
│   ├── views.py
│   └──migrations
│   │     └── __init__.py
│   │          
│   └── static
│   │   └── business_app
│   │       ├── css
│   │       │    └──style.css      
│   │       ├── images
│   │       │   └──logo_green.png       
│   │       └──js
│   └─ templates
│       ├── account  
│       │   ├── login.html
│       │   └── signup.html
│       │
│       └──business_app
│       │   ├── main_page.html
│       │   ├── page_errors.html
│       │   ├── profile.html
│       │   ├── update_profile.html
│       │   │
│       │   ├── sale.html
│       │   ├── order_form.html
│       │   │
│       │   ├── purchase.html
│       │   ├── product_detail.html
│       │   ├── product_list.html
│       │   ├── update_product.html
│       │   │
│       │   └── review.html
│       └── base.html 
│
├── telegram_bot
│   ├── management
│   │   └── commands
│   │       ├── __init__.py
│   │       └── runbot.py
│   ├── migrations
│   │     └── __init__.py
│   │ 
│   ├── __init__.py
│   ├── bot.py
│   ├── models.py
│   ├── keyboards.py
│   ├── notifications.py
│   ├── notifications_telegram_key.py
│   ├── reports.py
│   └──  handlers.py
│
├── myproject
│     ├── __init__.py   
│     ├── asgi.py
│     ├── settings.py
│     ├── urls.py
│     └── wsgi.py
├── media/
├── db.sqlite3
├── manage.py       
└── structure.txt 

## 4. Функциональность

### 4.1. Особенности авторизации
Помимо штатной административной панели Django /admin для авторизации на сайте в модуле настроек settings.py 
использованы элементы кастомизированной авторизации с использованием библиотеки allauth

Не авторизованные пользователи не видят навигационные элементы и шаблоны, доступные авторизованным пользователям.
Авторизованные пользователи имеют доступ к навигационным элементам и шаблонам только в соответствии со своей ролью.

Пользователю с ролью superuser определены полномочия по изменению роли пользователей и управление сайтом.
Технически через административную панель Django можно реализовать более широкий функционал и управление, 
но в целях разработки функциональности на сайте они в проекте применены ограниченно.

### 4.2. Создание заказов
Заказы создаются в приложении веб-сайта business_app. После выбора первого товара пользовтаель 
попадает в форму корзины /cart_detail. Пользователь может добавлять или удалять продукты из корзины. 

Предполагается, что заказ создается в статусе подтвержден (этап оплаты можно реализовать дополнительно, 
в т.ч. Через подключение сторонних API).

После добавления в корзину продукта пользователь переходит в страницу "Мои покупки" /purchase.
Предполагается, что пользователь может оформлять несколько заказов, изменять или отменять текущие до их отправки.

В поле формы заказа содержится поле telegram_key для подписки на уведомления о новых заказах. 
telegram_key - это имя пользователя в телеграме. Например, @username. Если он подписан на бот - 
ему будут поступать уведомления о создании и изменении статуса заказа.

### 4.3. Управление заказами
Работники магазина могут просматривать и управлять заказами через шаблон "Мои продажи" /sale.
Реализован функционал изменения статуса заказа. Продавец выбирает из списка новый статус, 
после чего нажимает на кнопку "Изменить статус". Для каждого состояния есть ограничение выбора вариантов статуса. 

### 4.4. Аналитика
Через навигационные элементы шаблона "Мои продажи" /sale работник может вызвать отчет и 
аналитику продаж за различные периоды. Анализ использует библиотеки numpy, pandas и matplotlib.

### 4.5. Отзывы
Покупатели могут оставлять отзывы через шаблон "Мои покупки" /purchase - нажав кнопку Отзыв, после чего 
происходит переадресация в шаблон /review. Отзывы публикуются в личном кабинете покупателя 
и доступном всем шаблоне /all_reviews. 

На один заказ доступен лишь один отзыв для создавшего заказ покупателя. 
Покупатель может вместе с отзывом выставить оценку.

Продавец через шаблон "Мои продажи" /sale видит наличие кнопки "Ответ на отзыв" в исторических заказах 
и переадресуется на страницу review данного заказа для размещения ответа, либо удаления отзыва. 

### 4.6. Управление каталогом и товарами
Продавец через шаблон "Мои продажи" /sale имеет доступ к шаблонам /product_list и /product, где может добавлять, 
изменять или менять статус активности товара. Неактивные товары не отображаются в каталоге, 
но сохраняются в качестве "базы знаний". Управление запасами не предусмотрено - предполагается, 
что все активные товары доступны для продажи. 
Специфика товара "Букеты", собираемые под заказ, поэтому запасы букетов не формируются.

Продавец также может менять статус активности товара непосредственно в каталоге на главной странице.
Отображение этой функциональности не доступно гостям и авторизованным покупателям.

## 5. Особенности уведомлений и работы телеграм-бота

### 5.1. Особенности уведомлений продавца
Продавец инициализирует бот, выбирает в инлайн-клавиатуре роль покупателя, проходит авторизацию.
После авторизации ему постпуает отчет в виде медиа-групп с инофрмацией о незавершенных заказах.
Используя команду /reports продавец вызывает доступ к меню с вариантами отчетов о продажах.
Отчет о продажах состоит из текстовой и графической части, частично дублируя представленные на веб-сайте.

### 5.2. Особенности уведомлений покупателя
Логика уведомления о заказе для покупателя или уполномоченного им пользователя отличается от уведомления продавца.
Авторизация не требуется. После инициализации бота происходит запись id и username в таблицу TelegramUser
При создании или изменении статуса заказа происходит сверка telegram_key в таблице Order и TelegramUser. 
При совпадении по записанному в TelegramUser id пользователя отправляется уведомление о создании или 
изменении статуса заказа. После завершения заказа статус не меняется и уведомления по этом заказу не отправляются.

### 5.3. Функции модулей бота
* /management/commands/runbot.py - запуск бота
* bot.py - обработчики команд
* keyboards.py - клавиатуры
* models.py - модель TelegramUser. Обработка сообщений для подписчиков при создании и изменении 
заказа в модели сайта Order
* notifications.py - обработка уведомлений работников магазина.
* notifications_telegram.py - содержит метод отправки сообщений по telegram_key
* reports.py - методы для генерации отчетов с использованием библиотек анализа.
* handlers.py - обработчики отчетов, управляющие их составом и периодом.

