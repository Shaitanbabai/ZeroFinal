{% extends "base.html" %}
{% load static %}

{% block content %}
<h2 class="mb-4">Форма заказа</h2>
<form method="post" class="mb-4">
    {% csrf_token %}

    <h3 class="mb-3">Ваши товары:</h3>
    <ul id="order_items" class="list-group mb-4">
    {% for item in products_with_quantities %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ item.product.name }} -
            <input type="number" class="quantity-input form-control w-25 d-inline" name="quantity_{{ item.product.id }}" value="{{ item.quantity }}" min="0"> шт.
            <a href="#" class="remove-item btn btn-link text-danger" data-item-id="{{ item.product.id }}">Удалить</a>
        </li>
    {% endfor %}
    </ul>
    <h3 class="cart-summary">Итог: <span id="total-price">{{ total_price }}</span></h3>

    <h3 class="mb-3 mt-4">Информация о заказе:</h3>
    <div class="form-group">
        {{ form.phone.label_tag }} {{ form.phone }}
    </div>
    <div class="form-group">
        {{ form.address.label_tag }} {{ form.address }}
    </div>
    <div class="form-group">
        {{ form.comment.label_tag }} {{ form.comment }}
    </div>

    <div class="mt-4">
        <button type="submit" class="nav-button">Оформить заказ</button>
        <a href="#" id="clear-cart" class="nav-button">Сбросить всё</a>
        <a href="{% url 'main_page' %}" class="nav-button">Добавить товар</a>
    </div>
</form>

<script src="{% static 'js/jquery.min.js' %}"></script>
<script>
    $(document).ready(function () {
        // Удалить элемент из корзины
        $('.remove-item').click(function (event) {
            event.preventDefault();
            var itemId = $(this).data('item-id');
            var itemElement = $(this).closest('.list-group-item');

            $.ajax({
                url: '{% url "order_form" %}',
                method: 'POST',
                data: {
                    action: 'remove',
                    product_id: itemId,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    // Удалить элемент из списка
                    itemElement.remove();
                    // Обновить итоговую сумму
                    $('#total-price').text(response.new_total_price);
                }
            });
        });

        // Очистить корзину
        $('#clear-cart').click(function (event) {
            event.preventDefault();

            $.ajax({
                url: '{% url "order_form" %}',
                method: 'POST',
                data: {
                    action: 'clear',
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    // Очистить список товаров
                    $('#order_items').empty();
                    // Обновить итоговую сумму
                    $('#total-price').text('0');
                }
            });
        });

        // Изменить количество товара
        $('.quantity-input').change(function () {
            var itemId = $(this).closest('.list-group-item').data('item-id');
            var newQuantity = $(this).val();
        });
    });
</script>
{% endblock %}